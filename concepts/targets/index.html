<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Targets Discovery - Cloudprober</title>
    <meta name="generator" content="Hugo 0.61.0" />

    
    <link rel="canonical" href="https://cloudprober.org/concepts/targets/">
    

    <meta property="og:url" content="https://cloudprober.org/concepts/targets/">
    <meta property="og:title" content="Cloudprober">
    
    <meta name="apple-mobile-web-app-title" content="Cloudprober">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://cloudprober.org/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://cloudprober.org/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://cloudprober.org/fonts/icon.eot');
        src: url('https://cloudprober.org/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://cloudprober.org/fonts/icon.woff')
               format('woff'),
             url('https://cloudprober.org/fonts/icon.ttf')
               format('truetype'),
             url('https://cloudprober.org/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/application.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/syntax.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto&#43;Mono">
    <style>
      body, input {
        font-family: 'Roboto', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://cloudprober.org/javascripts/modernizr.js"></script>

    

  </head>
  <body class=" ">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Targets Discovery
      </div>
    </div>

    

    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/google/cloudprober" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>Cloudprober </strong>
        
          <br>
          google/cloudprober
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/google/cloudprober/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/google/cloudprober/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Overview" href="https://cloudprober.org/">
	
	Overview
</a>



  
</li>



<li>
  
    



<a  title="Getting Started" href="https://cloudprober.org/getting-started/">
	
	Getting Started
</a>



  
</li>



<li>
  
    



<a  title="What is a Probe" href="https://cloudprober.org/concepts/probe/">
	
	What is a Probe
</a>



  
</li>



<li>
  
    



<a class="current" title="Targets Discovery" href="https://cloudprober.org/concepts/targets/">
	
	Targets Discovery
</a>


<ul id="scrollspy">
</ul>


  
</li>



<li>
  
    <span class="section">How-Tos</span>
    <ul>
      
        
        



<a  title="Running On Kubernetes" href="https://cloudprober.org/how-to/run-on-kubernetes/">
	
	Running On Kubernetes
</a>



      
        
        



<a  title="External Probe" href="https://cloudprober.org/how-to/external-probe/">
	
	External Probe
</a>



      
        
        



<a  title="Validators" href="https://cloudprober.org/how-to/validators/">
	
	Validators
</a>



      
        
        



<a  title="Built-in Servers" href="https://cloudprober.org/how-to/built-in-servers/">
	
	Built-in Servers
</a>



      
        
        



<a  title="Extending Cloudprober" href="https://cloudprober.org/how-to/extensions/">
	
	Extending Cloudprober
</a>



      
    </ul>
  
</li>


        </ul>
        

        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Targets Discovery </h1>

			<p>Automatic and continuous discovery of the targets is one of the core features of
Cloudprober. This feature is specially critical for the dynamic environments that today's cloud based deployments make possible. For exmaple, in a kubernetes cluster number of pods and their IPs can change on the fly, either in response to replica count changes or node failures. Automated targets discovery makes sure that we don't have to reconfigure Cloudprober in response to such events.</p>
<h2 id="overview">Overview</h2>
<p>The main idea behind Cloudprober's targets discovery is to use an independent source of truth to figure out the targets we are supposed to monitor. This source of truth is usually the resource provider's API, for example, GCE API and Kubernetes API. Cloudprober periodically polls these APIs to get the latest list of resources.</p>
<p>Example targets configuration:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">targets <span class="o">{</span>
  rds_targets <span class="o">{</span>
    <span class="c1"># Monitor all endpoints for the service service-a</span>
    resource_path: <span class="s2">&#34;k8s://endpoints/service-a&#34;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Some salient features of the cloudprober's targets discovery:</p>
<ul>
<li>Continuous discovery. We don't just discover targets in the beginning, but keep refreshing them at a regular interval.</li>
<li>Protection against the upstream provider failures. If refreshing of the targets fails during one of the refresh cycles, we continue using the existing set of targets.</li>
<li>Targets data includes name, labels, IP and ports (labels and ports are optional). These details allow configuring probes, for example, automatically setting port in the HTTP probe, and using target lables for probe results labeling.</li>
<li>Well-defined protobuf based API (RDS &ndash; more on it below) to add support for more target types.</li>
<li>Currently supports GCE and Kubernetes resources. Adding more resource types should be straightforward.</li>
</ul>
<p>Cloudprober currently (<strong>as of v0.10.7</strong>) supports following types of dynamic targets:</p>
<table>
<thead>
<tr>
<th>Resource Provider</th>
<th>Resource Types</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes (k8s)</td>
<td>pods, endpoints, services</td>
</tr>
<tr>
<td>GCP (gcp)</td>
<td>gce_instances, pubsub_messages</td>
</tr>
</tbody>
</table>
<h2 id="resource-discovery-service">Resource Discovery Service</h2>
<p>To provide a consistent interface between targets&rsquo; configuration and the actual implementation, Cloudprober defines and uses a protocol called RDS (Resource Discovery Service). Cloudprober's targets module includes a targets type &ldquo;rds_targets&rdquo;, that talks to an RDS backend that is either part of the same process or available over gRPC.</p>
<p><a href="https://cloudprober.org/diagrams/rds_targets.png"><img style="float: center;" width=450px src="https://cloudprober.org/diagrams/rds_targets.png"></a></p>
<p>Here are the RDS targets configuration (<a href="https://github.com/google/cloudprober/blob/86a1d1fcd2f8505c45ff462d69458fd5b9964e5f/targets/proto/targets.proto#L12">RDSTargets</a>) options:</p>
<div class="highlight"><pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">RDSTargets</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="c1">// RDS server options, for example:
</span><span class="c1"></span>  <span class="c1">// rds_server_options {
</span><span class="c1"></span>  <span class="c1">//   server_address: &#34;rds-server.xyz:9314&#34;
</span><span class="c1"></span>  <span class="c1">//   oauth_config: {
</span><span class="c1"></span>  <span class="c1">//     ...
</span><span class="c1"></span>  <span class="c1">//   }
</span><span class="c1"></span>  <span class="c1">// }
</span><span class="c1"></span>  <span class="c1">// Default is to use the local server if any.
</span><span class="c1"></span>  <span class="k">optional</span> <span class="n">rds.ClientConf.ServerOptions</span> <span class="n">rds_server_options</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span>  <span class="c1">// Resource path specifies the resources to return. Resources paths have the
</span><span class="c1"></span>  <span class="c1">// following format:
</span><span class="c1"></span>  <span class="c1">// &lt;resource_provider&gt;://&lt;resource_type&gt;/&lt;additional_params&gt;
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// Examples:
</span><span class="c1"></span>  <span class="c1">// For GCE instances in projectA: &#34;gcp://gce_instances/&lt;projectA&gt;&#34;
</span><span class="c1"></span>  <span class="c1">// Kubernetes Pods : &#34;k8s://pods&#34;
</span><span class="c1"></span>  <span class="k">optional</span> <span class="kt">string</span> <span class="n">resource_path</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span>  <span class="c1">// Filters to filter resources by. Example:
</span><span class="c1"></span>  <span class="c1">// filter {
</span><span class="c1"></span>  <span class="c1">//   key: &#34;namespace&#34;
</span><span class="c1"></span>  <span class="c1">//   value: &#34;mynamesspace&#34;
</span><span class="c1"></span>  <span class="c1">// }
</span><span class="c1"></span>  <span class="c1">// filter {
</span><span class="c1"></span>  <span class="c1">//   key: &#34;labels.app&#34;
</span><span class="c1"></span>  <span class="c1">//   value: &#34;web-service&#34;
</span><span class="c1"></span>  <span class="c1">// }
</span><span class="c1"></span>  <span class="k">repeated</span> <span class="n">rds.Filter</span> <span class="n">filter</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span>  <span class="c1">// IP config to specify the IP address to pick for a resource. IPConfig
</span><span class="c1"></span>  <span class="c1">// is defined here:
</span><span class="c1"></span>  <span class="c1">// https://github.com/google/cloudprober/blob/master/rds/proto/rds.proto
</span><span class="c1"></span>  <span class="k">optional</span> <span class="n">rds.IPConfig</span> <span class="n">ip_config</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></div><p>Most options are explained in the comments for quick references. Here is the further explanation of some of these options:</p>
<h3 id="rds-server-options">rds_server_options</h3>
<p>This <a href="https://github.com/google/cloudprober/blob/86a1d1fcd2f8505c45ff462d69458fd5b9964e5f/rds/client/proto/config.proto#L19">field</a> specifies how to connect to the RDS server: server address and security options (OAuth and TLS). If left unspecified, it connects to the local server if any (started through <code>rds_server</code> option). Next up it looks for the <code>rds_server_options</code> in <a href="https://github.com/google/cloudprober/blob/86a1d1fcd2f8505c45ff462d69458fd5b9964e5f/targets/proto/targets.proto#L125">global_targets_options</a>.</p>
<h3 id="resource-path">resource_path</h3>
<p>Resource path specifies the resources we are interested in. It consists of <em>resource provider</em>, <em>resource type</em> and optional <em>relative path</em>: <code>&lt;resource_provider&gt;://&lt;resource_type&gt;/&lt;optional_relative_path&gt;</code></p>
<ul>
<li><code>resource_provider</code>: Resource provider is a generic concept within the RDS protocol but usually maps to the cloud provider. Cloudprober RDS server currently implements the Kubernetes (k8s) and GCP (gcp) resource providers. We plan to add more resource providers in future.</li>
<li><code>resource_type</code>: Available resource types depend on the providers, for example, for k8s provider supports the following resource types: <em>pods</em>, <em>endpoints</em>, and <em>services</em>.</li>
<li><code>optional_relative_path</code>: For most resource types you can specify resource name in the resource path itself, e.g. <code>k8s://services/cloudprober</code>. Alternatively, you can use filters to filter by name, resource, etc.</li>
</ul>
<h3 id="filter">filter</h3>
<p>Filters are key-value strings that can be used to filter resources by various fields. Filters depend on the resource types, but most resources support filtering by name and labels.</p>
<pre><code># Return resources that start with &quot;web&quot; and have label &quot;service:service-a&quot;
...
 filter {
   key: &quot;name&quot;
   value: &quot;^web.*&quot;
 }
 filter {
   key: &quot;labels.service&quot;
   value: &quot;service-a&quot;
 }
</code></pre><ul>
<li>Filters supported by kubernetes resources: <a href="https://github.com/google/cloudprober/blob/e4a0321d38d75fb4655d85632b52039fa7279d1b/rds/kubernetes/kubernetes.go#L55">k8s filters</a>.</li>
<li>Filters supported by GCP:
<ul>
<li><a href="https://github.com/google/cloudprober/blob/e4a0321d38d75fb4655d85632b52039fa7279d1b/rds/gcp/gce_instances.go#L44">GCE Instances</a></li>
<li><a href="https://github.com/google/cloudprober/blob/e4a0321d38d75fb4655d85632b52039fa7279d1b/rds/gcp/pubsub.go#L34">Pub/Sub Messages</a></li>
</ul>
</li>
</ul>
<h2 id="running-rds-server">Running RDS Server</h2>
<p>RDS server can either be run as an independent process or it can be part of the main prober process. Former mode is useful for large deployments where you may want to reduce the API upcall traffic (for example, to GCP). For example, if you run 1000+ prober processes, it will be much more economical, from the API quota usage point of view, to have a centralized RDS service with much fewer (2-3) instances instead of having each prober process make its own API calls.</p>
<p>RDS server can be added to a cloudprober process using the <code>rds_server</code> stanza. If you're running RDS server in a remote process, you'll have to enable gRPC server in that process (using <code>grpc_port</code>) so that other instances can access it remotely.</p>
<p>Here is an example RDS server configuration:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">rds_server <span class="o">{</span>
  <span class="c1"># GCP provider to discover GCP resources.</span>
  provider <span class="o">{</span>
    gcp_config <span class="o">{</span>
      <span class="c1"># Projects to discover resources in.</span>
      project: <span class="s2">&#34;test-project-1&#34;</span>
      project: <span class="s2">&#34;test-project-2&#34;</span>

      <span class="c1"># Discover GCE instances in us-central1.</span>
      gce_instances <span class="o">{</span>
        zone_filter: <span class="s2">&#34;name = us-central1-*&#34;</span>
        re_eval_sec: <span class="m">60</span>  <span class="c1"># How often to refresh, default is 300s.</span>
      <span class="o">}</span>

      <span class="c1"># GCE forwarding rules.</span>
      forwarding_rules <span class="o">{</span><span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1"># Kubernetes targets are further discussed at:</span>
  <span class="c1"># https://cloudprober.org/how-to/run-on-kubernetes/#kubernetes-targets</span>
  provider <span class="o">{</span>
    kubernetes_config <span class="o">{</span>
      endpoints <span class="o">{</span><span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1"># Enable gRPC server for RDS. Only required for remote access to RDS server.</span>
grpc_port: <span class="m">9314</span>
</code></pre></div><p>For the remote RDS server setup, if accessing over internet, you can secure the underlying gRPC communication using <a href="https://github.com/google/cloudprober/blob/master/config/proto/config.proto#L91">TLS certificates</a>.</p>


			<aside class="copyright" role="note">
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				
			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/cloudprober.org\/';
      var repo_id  = 'google\/cloudprober';
    
    </script>

    <script src="https://cloudprober.org/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "Â¶";
            headers[i].appendChild(a);
        }
      }
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-79661-8', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
         
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    
  </body>
</html>

