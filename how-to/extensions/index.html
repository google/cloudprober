<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Extending Cloudprober - Cloudprober</title>
    <meta name="generator" content="Hugo 0.61.0" />

    
    <link rel="canonical" href="https://cloudprober.org/how-to/extensions/">
    

    <meta property="og:url" content="https://cloudprober.org/how-to/extensions/">
    <meta property="og:title" content="Cloudprober">
    
    <meta name="apple-mobile-web-app-title" content="Cloudprober">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://cloudprober.org/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://cloudprober.org/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://cloudprober.org/fonts/icon.eot');
        src: url('https://cloudprober.org/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://cloudprober.org/fonts/icon.woff')
               format('woff'),
             url('https://cloudprober.org/fonts/icon.ttf')
               format('truetype'),
             url('https://cloudprober.org/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/application.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/syntax.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto&#43;Mono">
    <style>
      body, input {
        font-family: 'Roboto', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://cloudprober.org/javascripts/modernizr.js"></script>

    

  </head>
  <body class=" ">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Extending Cloudprober
      </div>
    </div>

    

    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/google/cloudprober" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>Cloudprober </strong>
        
          <br>
          google/cloudprober
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/google/cloudprober/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/google/cloudprober/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Overview" href="https://cloudprober.org/">
	
	Overview
</a>



  
</li>



<li>
  
    



<a  title="Getting Started" href="https://cloudprober.org/getting-started/">
	
	Getting Started
</a>



  
</li>



<li>
  
    



<a  title="What is a Probe" href="https://cloudprober.org/concepts/probe/">
	
	What is a Probe
</a>



  
</li>



<li>
  
    



<a  title="Targets Discovery" href="https://cloudprober.org/concepts/targets/">
	
	Targets Discovery
</a>



  
</li>



<li>
  
    <span class="section">How-Tos</span>
    <ul>
      
        
        



<a  title="Running On Kubernetes" href="https://cloudprober.org/how-to/run-on-kubernetes/">
	
	Running On Kubernetes
</a>



      
        
        



<a  title="External Probe" href="https://cloudprober.org/how-to/external-probe/">
	
	External Probe
</a>



      
        
        



<a  title="Validators" href="https://cloudprober.org/how-to/validators/">
	
	Validators
</a>



      
        
        



<a  title="Built-in Servers" href="https://cloudprober.org/how-to/built-in-servers/">
	
	Built-in Servers
</a>



      
        
        



<a class="current" title="Extending Cloudprober" href="https://cloudprober.org/how-to/extensions/">
	
	Extending Cloudprober
</a>


<ul id="scrollspy">
</ul>


      
    </ul>
  
</li>


        </ul>
        

        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Extending Cloudprober </h1>

			<p>Cloudprober allows you to extend it across &ldquo;probe&rdquo; and &ldquo;target&rdquo; dimensions,
that is, you can add new probe and target types to it without having to fork
the entire codebase. Note that to extend cloudprober in this way, you will have
to maintain your own cloudprober binary (which is mostly a wrapper around the
&ldquo;cloudprober package&rdquo;), but you'll be able to use rest of the cloudprober code
from the common location.</p>
<h2 id="sample-probe-type">Sample probe type</h2>
<p>To demonstrate how it works, let's add a new probe-type to Cloudprober. We'll
take the sample redis probe that we added in the
<a href="https://cloudprober.org/how-to/external-probe/#sample-probe">external probe how-to</a>,
and convert it into a probe type that one can easily re-use. Let's say that
this probe-type provides a way to test redis server functionality and it takes
the following options - operation (GET vs SET vs DELETE), key, value. This
probe's configuration looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">probe <span class="o">{</span>
  name: <span class="s2">&#34;redis_set&#34;</span>
  type: EXTENSION
  targets <span class="o">{</span>
    host_names: <span class="s2">&#34;localhost:6379&#34;</span>
  <span class="o">}</span>
  redis_probe <span class="o">{</span>
    op: <span class="s2">&#34;set&#34;</span>
    key: <span class="s2">&#34;testkey&#34;</span>
    value: <span class="s2">&#34;testval&#34;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>To make cloudprober understand this config, we'll have to do a few things:</p>
<ul>
<li>
<p>Define the probe config in a protobuf (.proto) file and mark it as an
extension of the overall config.</p>
</li>
<li>
<p>Implement the probe type, possibly as a Go package, even though it can
be embedded directly into the top-level binary.</p>
</li>
<li>
<p>Create a new cloudprober binary that includes the new probe type package.</p>
</li>
</ul>
<h2 id="protobuf-for-the-new-probe-type">Protobuf for the new probe type</h2>
<p>Let's create a new directory for our code: <code>$GOPATH/src/myprober</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="c1">// File: $GOPATH/src/myprober/myprobe/myprobe.proto
</span><span class="c1"></span><span class="err">
</span><span class="err"></span><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto2&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;github.com/google/cloudprober/probes/proto/config.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="kn">package</span> <span class="nn">myprober</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">ProbeConf</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="c1">// Redis operation
</span><span class="c1"></span>  <span class="k">required</span> <span class="kt">string</span> <span class="n">op</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span>  <span class="c1">// Key and value for the redis operation
</span><span class="c1"></span>  <span class="k">required</span> <span class="kt">string</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="k">optional</span> <span class="kt">string</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="kd">extend</span> <span class="nc">cloudprober</span><span class="o">.</span><span class="n">probes.ProbeDef</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="k">optional</span> <span class="n">ProbeConf</span> <span class="n">redis_probe</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span></code></pre></div>
<p>Let's generate Go code for this protobuf:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># From the myprober directory</span>
protoc --go_out<span class="o">=</span>.,import_path<span class="o">=</span>myprobe:. --proto_path<span class="o">=</span><span class="nv">$GOPATH</span>/src:. myprobe/*.proto

$ ls myprobe/
myprobe.pb.go  myprobe.proto</code></pre></div>
<h2 id="implement-the-probe-type">Implement the probe type</h2>
<p>Now let's implement our probe type. Our probe type should implement the
<a href="https://godoc.org/github.com/google/cloudprober/probes#Probe">probes.Probe</a> interface.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">myprobe</span>

<span class="c1">// Probe holds aggregate information about all probe runs, per-target.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Probe</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">name</span>    <span class="kt">string</span>
  <span class="nx">c</span>       <span class="o">*</span><span class="nx">configpb</span><span class="p">.</span><span class="nx">ProbeConf</span>
  <span class="nx">targets</span> <span class="p">[</span><span class="p">]</span><span class="kt">string</span>
  <span class="nx">opts</span>    <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">Options</span>
  <span class="o">...</span>
<span class="p">}</span>

<span class="c1">// Init initializes the probe with the given params.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Probe</span><span class="p">)</span> <span class="nf">Init</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">c</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ProbeConf</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">ProbeConf</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;not a my probe config&#34;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// initialize p fields, p.name = name, etc.
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// Start runs the probe indefinitely, at the configured interval.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Probe</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dataChan</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">EventMetrics</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">probeTicker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Interval</span><span class="p">)</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="k">select</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
      <span class="nx">probeTicker</span><span class="p">.</span><span class="nf">Stop</span><span class="p">(</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">probeTicker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
      <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">em</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">res</span> <span class="p">{</span>
        <span class="nx">dataChan</span> <span class="o">&lt;-</span> <span class="nx">em</span>
      <span class="p">}</span>
      <span class="nx">p</span><span class="p">.</span><span class="nx">targets</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Targets</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="p">)</span>
      <span class="o">...</span>
      <span class="nx">probeCtx</span><span class="p">,</span> <span class="nx">cancelFunc</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithDeadline</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Timeout</span><span class="p">)</span><span class="p">)</span>
      <span class="nx">p</span><span class="p">.</span><span class="nf">runProbe</span><span class="p">(</span><span class="nx">probeCtx</span><span class="p">)</span>
      <span class="nf">cancelFunc</span><span class="p">(</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// runProbe runs probe for all targets and update EventMetrics.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Probe</span><span class="p">)</span> <span class="nf">runProbe</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">p</span><span class="p">.</span><span class="nx">targets</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Targets</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="p">)</span>

  <span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">target</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">targets</span> <span class="p">{</span>
    <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">target</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">em</span> <span class="o">*</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">EventMetrics</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span>
      <span class="nx">em</span><span class="p">.</span><span class="nf">Metric</span><span class="p">(</span><span class="s">&#34;total&#34;</span><span class="p">)</span><span class="p">.</span><span class="nf">AddInt64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(</span><span class="p">)</span>
      <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">runProbeForTarget</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span> <span class="c1">// run probe just for a single target
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="nx">em</span><span class="p">.</span><span class="nf">Metric</span><span class="p">(</span><span class="s">&#34;success&#34;</span><span class="p">)</span><span class="p">.</span><span class="nf">AddInt64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="nx">em</span><span class="p">.</span><span class="nf">Metric</span><span class="p">(</span><span class="s">&#34;latency&#34;</span><span class="p">)</span><span class="p">.</span><span class="nf">AddFloat64</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span><span class="p">.</span><span class="nf">Seconds</span><span class="p">(</span><span class="p">)</span> <span class="o">/</span> <span class="nx">p</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">LatencyUnit</span><span class="p">.</span><span class="nf">Seconds</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
    <span class="p">}</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">res</span><span class="p">[</span><span class="nx">target</span><span class="p">]</span><span class="p">)</span>

  <span class="p">}</span>

  <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<p>Full example in
<a href="https://github.com/google/cloudprober/blob/master/examples/extensions/myprober/myprobe/myprobe.go">examples/extensions/myprober/myprobe/myprobe.go</a>.</p>
<p>This probe type sets or gets (depending on the configuration) a key-valye in
redis and records success and time taken (latency) if operation is successful.</p>
<h2 id="implement-a-cloudprober-binary-that-includes-support-for-our-probe">Implement a cloudprober binary that includes support for our probe</h2>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="o">...</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="p">)</span>

  <span class="c1">// Register our probe type
</span><span class="c1"></span>  <span class="nx">probes</span><span class="p">.</span><span class="nf">RegisterProbeType</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">myprobe</span><span class="p">.</span><span class="nx">E_RedisProbe</span><span class="p">.</span><span class="nx">Field</span><span class="p">)</span><span class="p">,</span>
                           <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="nx">probes</span><span class="p">.</span><span class="nx">Probe</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">myprobe</span><span class="p">.</span><span class="nx">Probe</span><span class="p">{</span><span class="p">}</span> <span class="p">}</span><span class="p">)</span>

  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cloudprober</span><span class="p">.</span><span class="nf">InitFromConfig</span><span class="p">(</span><span class="nf">getConfig</span><span class="p">(</span><span class="p">)</span><span class="p">)</span> <span class="c1">// getConfig not shown here.
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">glog</span><span class="p">.</span><span class="nf">Exitf</span><span class="p">(</span><span class="s">&#34;Error initializing cloudprober. Err: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// web.Init sets up web UI for cloudprober.
</span><span class="c1"></span>  <span class="nx">web</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="p">)</span>

  <span class="nx">cloudprober</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>

  <span class="c1">// Wait forever
</span><span class="c1"></span>  <span class="k">select</span> <span class="p">{</span><span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Full example in
<a href="https://github.com/google/cloudprober/blob/master/examples/extensions/myprober/myprober.go">examples/extensions/myprober/myprober.go</a>.</p>
<p>Let's write a test config that uses the newly defined probe type:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">probe <span class="o">{</span>
  name: <span class="s2">&#34;redis_set&#34;</span>
  type: EXTENSION
  interval_msec: <span class="m">10000</span>
  timeout_msec: <span class="m">5000</span>
  targets <span class="o">{</span>
    host_names: <span class="s2">&#34;localhost:6379&#34;</span>
  <span class="o">}</span>
  <span class="o">[</span>myprober.redis_probe<span class="o">]</span> <span class="o">{</span>
    op: <span class="s2">&#34;set&#34;</span>
    key: <span class="s2">&#34;testkey&#34;</span>
    value: <span class="s2">&#34;testval&#34;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>Full example in
<a href="https://github.com/google/cloudprober/blob/master/examples/extensions/myprober/myprober.cfg">examples/extensions/myprober/myprober.cfg</a>.</p>
<p>Let's compile our prober and run it with the above config:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">go build ./myprober.go
./myprober --config_file<span class="o">=</span>myprober.cfg</code></pre></div>
<p>you should see an output like the following:
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">cloudprober 1540848577649139842 1540848587 labels=ptype=redis,probe=redis_set,dst=localhost:6379 total=31 success=31 latency=70579.823
cloudprober 1540848577649139843 1540848887 labels=ptype=sysvars,probe=sysvars hostname=&#34;manugarg-macbookpro5.roam.corp.google.com&#34; start_timestamp=&#34;1540848577&#34;
cloudprober 1540848577649139844 1540848887 labels=ptype=sysvars,probe=sysvars uptime_msec=310007.784 gc_time_msec=0.000 mallocs=14504 frees=826
cloudprober 1540848577649139845 1540848887 labels=ptype=sysvars,probe=sysvars goroutines=12 mem_stats_sys_bytes=7211256
cloudprober 1540848577649139846 1540848587 labels=ptype=redis,probe=redis_set,dst=localhost:6379 total=32 success=32 latency=72587.981
cloudprober 1540848577649139847 1540848897 labels=ptype=sysvars,probe=sysvars hostname=&#34;manugarg-macbookpro5.roam.corp.google.com&#34; start_timestamp=&#34;1540848577&#34;
cloudprober 1540848577649139848 1540848897 labels=ptype=sysvars,probe=sysvars uptime_msec=320006.541 gc_time_msec=0.000 mallocs=14731 frees=844
cloudprober 1540848577649139849 1540848897 labels=ptype=sysvars,probe=sysvars goroutines=12 mem_stats_sys_bytes=7211256</code></pre></div></p>
<p>You can import this data in prometheus following the process outlined at:
<a href="https://cloudprober.org/getting-started/#running-prometheus">Running Prometheus</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The article shows how to add a new probe type to cloudprober. Extending
cloudprober allows you to implement new probe types that may make sense for your
organization, but not for the open source community. You have to implement the
logic for the probe type, but other cloudprober features work as it is &ndash;
targets, metrics (e.g. latency distribution if you configure it), surfacers -
data can be multiple systems simultaneously, etc.</p>


			<aside class="copyright" role="note">
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				
			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/cloudprober.org\/';
      var repo_id  = 'google\/cloudprober';
    
    </script>

    <script src="https://cloudprober.org/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "¶";
            headers[i].appendChild(a);
        }
      }
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-79661-8', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
         
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    
  </body>
</html>

