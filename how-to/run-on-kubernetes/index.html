<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Running On Kubernetes - Cloudprober</title>
    <meta name="generator" content="Hugo 0.61.0" />

    
    <link rel="canonical" href="https://cloudprober.org/how-to/run-on-kubernetes/">
    

    <meta property="og:url" content="https://cloudprober.org/how-to/run-on-kubernetes/">
    <meta property="og:title" content="Cloudprober">
    
    <meta name="apple-mobile-web-app-title" content="Cloudprober">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://cloudprober.org/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://cloudprober.org/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://cloudprober.org/fonts/icon.eot');
        src: url('https://cloudprober.org/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://cloudprober.org/fonts/icon.woff')
               format('woff'),
             url('https://cloudprober.org/fonts/icon.ttf')
               format('truetype'),
             url('https://cloudprober.org/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/application.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/syntax.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto&#43;Mono">
    <style>
      body, input {
        font-family: 'Roboto', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://cloudprober.org/javascripts/modernizr.js"></script>

    

  </head>
  <body class=" ">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Running On Kubernetes
      </div>
    </div>

    

    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/google/cloudprober" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>Cloudprober </strong>
        
          <br>
          google/cloudprober
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/google/cloudprober/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/google/cloudprober/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Overview" href="https://cloudprober.org/">
	
	Overview
</a>



  
</li>



<li>
  
    



<a  title="Getting Started" href="https://cloudprober.org/getting-started/">
	
	Getting Started
</a>



  
</li>



<li>
  
    



<a  title="What is a Probe" href="https://cloudprober.org/concepts/probe/">
	
	What is a Probe
</a>



  
</li>



<li>
  
    



<a  title="Targets Discovery" href="https://cloudprober.org/concepts/targets/">
	
	Targets Discovery
</a>



  
</li>



<li>
  
    <span class="section">How-Tos</span>
    <ul>
      
        
        



<a class="current" title="Running On Kubernetes" href="https://cloudprober.org/how-to/run-on-kubernetes/">
	
	Running On Kubernetes
</a>


<ul id="scrollspy">
</ul>


      
        
        



<a  title="External Probe" href="https://cloudprober.org/how-to/external-probe/">
	
	External Probe
</a>



      
        
        



<a  title="Validators" href="https://cloudprober.org/how-to/validators/">
	
	Validators
</a>



      
        
        



<a  title="Built-in Servers" href="https://cloudprober.org/how-to/built-in-servers/">
	
	Built-in Servers
</a>



      
        
        



<a  title="Extending Cloudprober" href="https://cloudprober.org/how-to/extensions/">
	
	Extending Cloudprober
</a>



      
    </ul>
  
</li>


        </ul>
        

        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Running On Kubernetes </h1>

			<p>Kubernetes is a popular platform for running containers, and Cloudprober container runs on Kubernetes right out of the box. This document shows how you can use config map to provide config to cloudprober and reload cloudprober on config changes.</p>
<h2 id="configmap">ConfigMap</h2>
<p>In Kubernetes, a convenient way to provide config to containers is to use config maps.  Let's create a config that specifies a probe to monitor &ldquo;google.com&rdquo;.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">probe <span class="o">{</span>
  name: <span class="s2">&#34;google-http&#34;</span>
  type: HTTP
  targets <span class="o">{</span>
    host_names: <span class="s2">&#34;www.google.com&#34;</span>
  <span class="o">}</span>
  http_probe <span class="o">{</span><span class="o">}</span>
  interval_msec: <span class="m">15000</span>
  timeout_msec: <span class="m">1000</span>
<span class="o">}</span>
</code></pre></div><p>Save this config in <code>cloudprober.cfg</code>, create a config map using the following command:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">kubectl create configmap cloudprober-config <span class="se">\
</span><span class="se"></span>  --from-file<span class="o">=</span>cloudprober.cfg<span class="o">=</span>cloudprober.cfg
</code></pre></div><h2 id="deployment-map">Deployment Map</h2>
<p>Now let's add a <code>deployment.yaml</code> to add the config volume and cloudprober container:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>apps/v1beta1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>cloudprober<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span>annotations<span class="p">:</span><span class="w">
</span><span class="w">        </span>checksum/config<span class="p">:</span><span class="w"> </span><span class="s2">&#34;${CONFIG_CHECKSUM}&#34;</span><span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">
</span><span class="w">        </span>app<span class="p">:</span><span class="w"> </span>cloudprober<span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>cloudprober-config<span class="w">
</span><span class="w">        </span>configMap<span class="p">:</span><span class="w">
</span><span class="w">          </span>name<span class="p">:</span><span class="w"> </span>cloudprober-config<span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>cloudprober<span class="w">
</span><span class="w">        </span>image<span class="p">:</span><span class="w"> </span>cloudprober/cloudprober<span class="w">
</span><span class="w">        </span>command<span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/cloudprober&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span>args<span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
</span><span class="w">          </span><span class="s2">&#34;--config_file&#34;</span><span class="p">,</span><span class="s2">&#34;/cfg/cloudprober.cfg&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">          </span><span class="s2">&#34;--logtostderr&#34;</span><span class="w">
</span><span class="w">        </span><span class="p">]</span><span class="w">
</span><span class="w">        </span>volumeMounts<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>cloudprober-config<span class="w">
</span><span class="w">          </span>mountPath<span class="p">:</span><span class="w"> </span>/cfg<span class="w">
</span><span class="w">        </span>ports<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>http<span class="w">
</span><span class="w">          </span>containerPort<span class="p">:</span><span class="w"> </span><span class="m">9313</span><span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span>apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>cloudprober<span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>app<span class="p">:</span><span class="w"> </span>cloudprober<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>ports<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>port<span class="p">:</span><span class="w"> </span><span class="m">9313</span><span class="w">
</span><span class="w">    </span>protocol<span class="p">:</span><span class="w"> </span>TCP<span class="w">
</span><span class="w">    </span>targetPort<span class="p">:</span><span class="w"> </span><span class="m">9313</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>app<span class="p">:</span><span class="w"> </span>cloudprober<span class="w">
</span><span class="w">  </span>type<span class="p">:</span><span class="w"> </span>NodePort<span class="w">
</span></code></pre></div><p>Note that we added an annotation to the deployment spec; this annotation allows us to update the deployment whenever cloudprober config changes. We can update this annotation based on the local cloudprober config content, and update the deployment using the following one-liner:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Update the config checksum annotation in deployment.yaml before running</span>
<span class="c1"># kubectl apply.</span>
<span class="nv">CONFIG_CHECKSUM</span><span class="o">=</span><span class="k">$(</span>kubectl get cm/cloudprober-config -o yaml <span class="p">|</span> sha256sum<span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>cat deployment.yaml <span class="p">|</span> envsubst <span class="p">|</span> kubectl apply -f -
</code></pre></div><p>(Note: If you use Helm for Kubernetes deployments, Helm provides <a href="https://helm.sh/docs/howto/charts_tips_and_tricks/#automatically-roll-deployments">a more native way</a> to include config checksums in deployments.)</p>
<p>Applying the above yaml file, should create a deployment with a service at port 9313:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ kubectl get deployment
NAME          READY   UP-TO-DATE   AVAILABLE   AGE
cloudprober   1/1     <span class="m">1</span>            <span class="m">1</span>           94m

$ kubectl get service cloudprober
NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE
cloudprober   NodePort   10.31.249.108   &lt;none&gt;        9313:31367/TCP   94m
</code></pre></div><p>Now you should be able to access various cloudprober URLs (<code>/status</code> for status,<code>/config</code> for config, <code>/metrics</code> for prometheus-format metrics) from within the cluster. For quick verification you can also set up a port forwarder and access these URLs locally at <code>localhost:9313</code>:</p>
<pre><code>kubectl port-forward svc/cloudprober 9313:9313
</code></pre><p>Once you've verified that everything is working as expected, you can go on setting up metrics collection through prometheus (or stackdriver) in usual ways.</p>
<h2 id="kubernetes-targets">Kubernetes Targets</h2>
<p>If you're running on Kuberenetes, you'd probably want to monitor Kubernetes resources (e.g. pods, endpoints, etc) as well. Good news is that cloudprober supports dynamic <a href="https://cloudprober.org/concepts/targets/">targets discovery</a> of Kubernetes resources.</p>
<p>For example, following config adds HTTP probing of Kubernetes endpoints named &lsquo;cloudprober&rsquo; (equivalent to <em>kubectl get ep cloudprober</em>).</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">probe <span class="o">{</span>
  name: <span class="s2">&#34;pod-to-endpoints&#34;</span>
  type: HTTP

  targets <span class="o">{</span>
    <span class="c1"># RDS (resource discovery service) targets</span>
    <span class="c1"># Equivalent to kubectl get ep cloudprober</span>
    rds_targets <span class="o">{</span>
      resource_path: <span class="s2">&#34;k8s://endpoints/cloudprober&#34;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  
  http_probe <span class="o">{</span>
    resolve_first: <span class="nb">true</span>
    relative_url: <span class="s2">&#34;/status&#34;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1"># Run an RDS gRPC server to discover Kubernetes targets.</span>
rds_server <span class="o">{</span>
  provider <span class="o">{</span>
    <span class="c1"># For all options, please take a look at:</span>
    <span class="c1"># https://github.com/google/cloudprober/blob/master/rds/kubernetes/proto/config.proto#L38</span>
    kubernetes_config <span class="o">{</span>
      endpoints <span class="o">{</span><span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>This config adds a probe for endpoints named &lsquo;cloudprober&rsquo;. Kubernetes targets configuration is further explained in the section below.</p>
<h3 id="kubernetes-rds-targets">Kubernetes RDS Targets</h3>
<p>As explained <a href="https://cloudprober.org/concepts/targets/#resource-discovery-service">here</a>, cloudprober uses RDS for dynamic targets discovery. In the above config, we add an internal RDS server that provides expansion for kubernetes <code>endpoints</code> (other supported types are &ndash; <em>pods</em>, <em>services</em>).  Inside the probe, we specify targets of the type <a href="https://cloudprober.org/concepts/targets/#resource-discovery-service">rds_targets</a> with resource path, <code>k8s://endpoints/cloudprober</code>. This resource path specifies resource of the type &lsquo;endpoints&rsquo; and with the name &lsquo;cloudprober&rsquo; (Hint: you can skip the name part of the resource path to discover all endpoints in the cluster).</p>
<h3 id="cluster-resources-access">Cluster Resources Access</h3>
<p>RDS server that we added above discovers cluster resources using kubernetes APIs. It assumes that we are interested in the cluster we are running it in, and uses in-cluster config to talk to the kubernetes API server. For this set up to work, we need to give our container read-only access to kubernetes resources:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Define a ClusterRole (resource-reader) for read-only access to the cluster</span><span class="w">
</span><span class="w"></span><span class="c"># resources and bind this ClusterRole to the default service account.</span><span class="w">
</span><span class="w">
</span><span class="w"></span>cat<span class="w"> </span>&lt;&lt;EOF<span class="w"> </span>|<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>-<span class="w">
</span><span class="w"></span>apiVersion<span class="p">:</span><span class="w"> </span>rbac.authorization.k8s.io/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>ClusterRole<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>annotations<span class="p">:</span><span class="w">
</span><span class="w">    </span>rbac.authorization.kubernetes.io/autoupdate<span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>resource-reader<span class="w">
</span><span class="w">  </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w"></span>rules<span class="p">:</span><span class="w">
</span><span class="w"></span>-<span class="w"> </span>apiGroups<span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span>resources<span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span>verbs<span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span>apiVersion<span class="p">:</span><span class="w"> </span>rbac.authorization.k8s.io/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>ClusterRoleBinding<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w"> </span>name<span class="p">:</span><span class="w"> </span>default-resource-reader<span class="w">
</span><span class="w"> </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w"></span>subjects<span class="p">:</span><span class="w">
</span><span class="w"></span>-<span class="w"> </span>kind<span class="p">:</span><span class="w"> </span>ServiceAccount<span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">  </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w"></span>roleRef<span class="p">:</span><span class="w">
</span><span class="w"> </span>kind<span class="p">:</span><span class="w"> </span>ClusterRole<span class="w">
</span><span class="w"> </span>name<span class="p">:</span><span class="w"> </span>resource-reader<span class="w">
</span><span class="w"> </span>apiGroup<span class="p">:</span><span class="w"> </span>rbac.authorization.k8s.io<span class="w">
</span><span class="w"></span>EOF<span class="w">
</span></code></pre></div><p>This will give <code>default</code> service account read-only access to the cluster resources. If you don't want to give the &ldquo;default&rdquo; user this access, you can create a new service account for cloudprober and use it in the deployment spec above.</p>
<h3 id="push-config-update">Push Config Update</h3>
<p>To push new cloudprober config to the cluster:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Update the config map</span>
kubectl create configmap cloudprober-config <span class="se">\
</span><span class="se"></span>  --from-file<span class="o">=</span>cloudprober.cfg<span class="o">=</span>cloudprober.cfg  -o yaml --dry-run <span class="p">|</span> <span class="se">\
</span><span class="se"></span>  kubectl replace -f -

<span class="c1"># Update deployment</span>
<span class="nv">CONFIG_CHECKSUM</span><span class="o">=</span><span class="k">$(</span>kubectl get cm/cloudprober-config -o yaml <span class="p">|</span> sha256sum<span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>cat deployment.yaml <span class="p">|</span> envsubst <span class="p">|</span> kubectl apply -f -
</code></pre></div><p>Cloudprober should now start monitoring cloudprober endpoints. To verify:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Set up port fowarding such that you can access cloudprober:9313 through</span>
<span class="c1"># localhost:9313.</span>
kubectl port-forward svc/cloudprober 9313:9313 <span class="p">&amp;</span>

<span class="c1"># Check config</span>
curl localhost:9313/config

<span class="c1"># Check metrics</span>
curl localhost:9313/metrics
</code></pre></div><p>If you're running on GKE and have not disabled cloud logging, you'll also see logs in <a href="https://pantheon.corp.google.com/logs/viewer?resource=gce_instance">Stackdriver Logging</a>.</p>


			<aside class="copyright" role="note">
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				
			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/cloudprober.org\/';
      var repo_id  = 'google\/cloudprober';
    
    </script>

    <script src="https://cloudprober.org/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "¶";
            headers[i].appendChild(a);
        }
      }
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-79661-8', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
         
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    
  </body>
</html>

