<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Stackdriver (Google Cloud Monitoring) - Cloudprober</title>
    <meta name="generator" content="Hugo 0.61.0" />

    
    <link rel="canonical" href="https://cloudprober.org/surfacers/stackdriver/">
    

    <meta property="og:url" content="https://cloudprober.org/surfacers/stackdriver/">
    <meta property="og:title" content="Cloudprober">
    
    <meta name="apple-mobile-web-app-title" content="Cloudprober">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://cloudprober.org/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://cloudprober.org/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://cloudprober.org/fonts/icon.eot');
        src: url('https://cloudprober.org/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://cloudprober.org/fonts/icon.woff')
               format('woff'),
             url('https://cloudprober.org/fonts/icon.ttf')
               format('truetype'),
             url('https://cloudprober.org/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/application.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://cloudprober.org/stylesheets/syntax.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto&#43;Mono">
    <style>
      body, input {
        font-family: 'Roboto', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://cloudprober.org/javascripts/modernizr.js"></script>

    

  </head>
  <body class=" ">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Stackdriver (Google Cloud Monitoring)
      </div>
    </div>

    

    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/google/cloudprober" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>Cloudprober </strong>
        
          <br>
          google/cloudprober
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/google/cloudprober/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/google/cloudprober/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Overview" href="https://cloudprober.org/">
	
	Overview
</a>



  
</li>



<li>
  
    



<a  title="Getting Started" href="https://cloudprober.org/getting-started/">
	
	Getting Started
</a>



  
</li>



<li>
  
    



<a  title="What is a Probe" href="https://cloudprober.org/concepts/probe/">
	
	What is a Probe
</a>



  
</li>



<li>
  
    



<a  title="Targets Discovery" href="https://cloudprober.org/concepts/targets/">
	
	Targets Discovery
</a>



  
</li>



<li>
  
    <span class="section">Exporting Metrics (Surfacers)</span>
    <ul>
      
        
        



<a  title="Surfacers" href="https://cloudprober.org/surfacers/overview/">
	
	Surfacers
</a>



      
        
        



<a class="current" title="Stackdriver (Google Cloud Monitoring)" href="https://cloudprober.org/surfacers/stackdriver/">
	
	Stackdriver (Google Cloud Monitoring)
</a>


<ul id="scrollspy">
</ul>


      
    </ul>
  
</li>



<li>
  
    <span class="section">How-Tos</span>
    <ul>
      
        
        



<a  title="Running On Kubernetes" href="https://cloudprober.org/how-to/run-on-kubernetes/">
	
	Running On Kubernetes
</a>



      
        
        



<a  title="External Probe" href="https://cloudprober.org/how-to/external-probe/">
	
	External Probe
</a>



      
        
        



<a  title="Validators" href="https://cloudprober.org/how-to/validators/">
	
	Validators
</a>



      
        
        



<a  title="Built-in Servers" href="https://cloudprober.org/how-to/built-in-servers/">
	
	Built-in Servers
</a>



      
        
        



<a  title="Extending Cloudprober" href="https://cloudprober.org/how-to/extensions/">
	
	Extending Cloudprober
</a>



      
    </ul>
  
</li>


        </ul>
        

        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Stackdriver (Google Cloud Monitoring) </h1>

			<p>Cloudprober can natively export metrics to Google Cloud Monitoring (formerly, Stackdriver) using stackdriver <a href="https://cloudprober.org/surfacers/overview">surfacer</a>.  Adding stackdriver surfacer to cloudprober is as simple as adding the following stanza to the config:</p>
<pre><code>surfacer {
  type: STACKDRIVER
}
</code></pre><p>This config will work if you're running on GCP and your VM (or GKE pod) has access to Cloud Monitoring (Stackdriver). If running on any other platform, you'll  have to specify the GCP project where you want to send the metrics, and you'll have to configure your environment for <a href="https://cloud.google.com/docs/authentication/production#automatically">Google Application Default Credentials</a>.</p>
<p>By default, stackdriver surfacer exports metrics with the following prefix: <code>custom.googleapis.com/cloudprober/&lt;probe-type&gt;/&lt;probe&gt;</code>. For example, for HTTP probe named <code>google_com</code>, standard metrics will be exported as:</p>
<pre><code>custom.googleapis.com/cloudprober/http/google_com/total
custom.googleapis.com/cloudprober/http/google_com/success
custom.googleapis.com/cloudprober/http/google_com/failure
custom.googleapis.com/cloudprober/http/google_com/latency
</code></pre><p>Here are all the config options for stackdriver surfacer:</p>
<div class="highlight"><pre class="chroma"><code class="language-protobuf" data-lang="protobuf">  <span class="c1">// GCP project name for stackdriver. If not specified and running on GCP,
</span><span class="c1"></span>  <span class="c1">// local project is used.
</span><span class="c1"></span>  <span class="k">optional</span> <span class="kt">string</span> <span class="n">project</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span>  <span class="c1">// If allowed_metrics_regex is specified, only metrics matching the given
</span><span class="c1"></span>  <span class="c1">// regular expression will be exported to stackdriver. Since probe type and
</span><span class="c1"></span>  <span class="c1">// probe name are part of the metric name, you can use this field to restrict
</span><span class="c1"></span>  <span class="c1">// stackdriver metrics to a particular probe.
</span><span class="c1"></span>  <span class="c1">// Example:
</span><span class="c1"></span>  <span class="c1">// allowed_metrics_regex: &#34;.*(http|ping).*(success|validation_failure).*&#34;
</span><span class="c1"></span>  <span class="k">optional</span> <span class="kt">string</span> <span class="n">allowed_metrics_regex</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span>  <span class="c1">// Monitoring URL base. Full metric URL looks like the following:
</span><span class="c1"></span>  <span class="c1">// &lt;monitoring_url&gt;/&lt;ptype&gt;/&lt;probe&gt;/&lt;metric&gt;
</span><span class="c1"></span>  <span class="c1">// Example:
</span><span class="c1"></span>  <span class="c1">// custom.googleapis.com/cloudprober/http/google-homepage/latency
</span><span class="c1"></span>  <span class="k">optional</span> <span class="kt">string</span> <span class="n">monitoring_url</span> <span class="o">=</span> <span class="mi">4</span><span class="err">
</span><span class="err"></span>      <span class="p">[</span><span class="k">default</span> <span class="o">=</span> <span class="s">&#34;custom.googleapis.com/cloudprober/&#34;</span><span class="p">]</span><span class="p">;</span><span class="err">
</span></code></pre></div><p>(Source: <a href="https://github.com/google/cloudprober/blob/master/surfacers/stackdriver/proto/config.proto">https://github.com/google/cloudprober/blob/master/surfacers/stackdriver/proto/config.proto</a>)</p>
<p>For example, you can configure stackdriver surfacer to export only metrics that match a specific regex:</p>
<div class="highlight"><pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="n">surfacer</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="n">stackdriver_surfacer</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="err">#</span> <span class="n">Export</span> <span class="n">only</span> <span class="s">&#34;http&#34;</span> <span class="n">probe</span> <span class="n">metrics.</span><span class="err">
</span><span class="err"></span>    <span class="n">allowed_metrics_regex</span><span class="o">:</span> <span class="s">&#34;.*\\/http\\/.*&#34;</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></div><h2 id="accessing-the-data">Accessing the data</h2>
<p>Cloudprober exports metrics to stackdriver as <a href="https://cloud.google.com/monitoring/custom-metrics">custom metrics</a>. Since all cloudprober metrics are counters (total number of probes, success, latency), you'll see rates of these metrics in stackdriver <a href="https://cloud.google.com/monitoring/charts/metrics-explorer">metrics explorer</a> by default. This data may not be very useful as it is (unless you're using distributions in cludprober, more on that later).</p>
<p>However, stackdriver now provides a powerful monitoring query language,<a href="https://cloud.google.com/monitoring/mql">MQL</a>, using which we can get more useful metrics.</p>
<p>MQL to get failure ratio:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">fetch global
<span class="p">|</span> <span class="o">{</span> metric <span class="s1">&#39;custom.googleapis.com/cloudprober/http/google_com/failure&#39;</span>
  <span class="p">;</span> metric <span class="s1">&#39;custom.googleapis.com/cloudprober/http/google_com/total&#39;</span> <span class="o">}</span>
<span class="p">|</span> align delta<span class="o">(</span>1m<span class="o">)</span>
<span class="p">|</span> join
<span class="p">|</span> div
</code></pre></div><p>MQL to get average latency for a probe:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">fetch global
<span class="p">|</span> <span class="o">{</span> metric <span class="s1">&#39;custom.googleapis.com/cloudprober/http/google_com/latency&#39;</span>
  <span class="p">;</span> metric <span class="s1">&#39;custom.googleapis.com/cloudprober/http/google_com/success&#39;</span> <span class="o">}</span>
<span class="p">|</span> align delta<span class="o">(</span>1m<span class="o">)</span>
<span class="p">|</span> join
<span class="p">|</span> div
</code></pre></div><p>You can use MQL to create graphs and generate alerts. Note that in the examples here we are fetching from the &ldquo;global&rdquo; source (<em>fetch global</em>); if you're running on GCP, you can improve performance of your queries by specifying the &ldquo;gce_instance&rdquo; resource type: <em>fetch gce_instance</em>.</p>


			<aside class="copyright" role="note">
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				
			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/cloudprober.org\/';
      var repo_id  = 'google\/cloudprober';
    
    </script>

    <script src="https://cloudprober.org/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "¶";
            headers[i].appendChild(a);
        }
      }
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-79661-8', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
         
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    
  </body>
</html>

